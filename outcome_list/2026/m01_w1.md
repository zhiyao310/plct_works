# RuyiSDK 下 GCC 对 LicheePi 4A（RevyOS） 的支持测试
- 目录

  - [一、简介](#简介)
  - [二、RuyiSDK 下 GCC 对 LicheePi 4A 的支持测试](#RuyiSDK 下 GCC 对 LicheePi 4A 的支持测试)
  - [三、在Ruyi  GCC 对 Cmake编译 的支持测试（以 Luanti 项目为例）](#在 Ruyi 虚拟环境下 GCC 对开源游戏运行的支持测试（以 Luanti 项目为例）)
  - [四、关于虚拟环境中 Ruyi GCC 编译适配的调试](#关于虚拟环境中 Ruyi GCC 编译适配的调试)
  ## 简介
  测试环境：

  - 硬件平台：LicheePi4A（RISC-V 架构）
  - 系统环境：RevyOS 嵌入式 RISC-V 发行版
  - 开发工具：RuyiSDK（gnu-plct-xthead 工具链）

  主要内容：

  - RuyiSDK 下 GCC 对 LicheePi 4A 的支持测试
  - Ruyi  GCC 对 Cmake编译 的支持测试（以 Luanti 项目为例）
  - 开发板运行验证

  ## RuyiSDK 下 GCC 对 LicheePi 4A 的支持测试   
  测试说明：验证 RuyiSDK 在 LicheePi4A 本机环境的安装、配置有效性
  | 序号 | 输入及操作说明                                               | 期望测试结果 |
  | ---- | ------------------------------------------------------------ | ------------ |
  | 1    | 安装 RuyiSDK 包管理器  <br>`  wget https://mirror.iscas.ac.cn/ruyisdk/ruyi/tags/0.44.0/ruyi-0.44.0.riscv64`<br>`chmod +x ./ruyi-0.44.0.riscv64`<br>`sudo cp -v ./ruyi-0.44.0.riscv64 /usr/local/bin/ruyi` | 成功安装     |
  | 2    | 获取远程软件源的内容并刷新本地软件包缓存  <br>`ruyi update`  | 成功获取     |
  | 3    | 安装gnu工具链  <br>`ruyi install gnu-plct-xthead`            | 成功安装     |
  | 4    | 创建Ruyi虚拟环境 <br>`ruyi venv -t gnu-plct-xthead sipeed-lpi4a ./venv-plct-luanti` | 成功创建     |
  | 5    | 激活虚拟环境<br>`. venv-plct-luanti/bin/ruyi-activate`       | 成功激活     |
  | 6    | 验证GCC版本<br>`riscv64-plctxthead-linux-gnu-gcc --version`  | 输出版本号   |
  ---
  ## 在 Ruyi 虚拟环境下 GCC 对开源游戏运行的支持测试（以 Luanti 项目为例）

  测试说明：验证 RuyiSDK 对于开源游戏运行的适配性

  | 序号 | 输入及操作说明                                               | 期望测试结果 |
  | ---- | ------------------------------------------------------------ | ------------ |
  | 1    | 更新系统软件包列表，确保获取最新的包信息 <br>`sudo apt update` | 成功更新     |
  | 2    | 安装基础编译工具（g++/make/cmake/git）和C标准库开发文件<br>`sudo apt install g++ make libc6-dev cmake git` | 成功安装     |
  | 3    | 安装各类依赖库<br>`sudo apt install libpng-dev libjpeg-dev libsqlite3-dev libogg-dev libvorbis-dev libopenal-dev libcurl4-gnutls-dev zlib1g-dev libgmp-dev libjsoncpp-dev libzstd-dev libluajit-5.1-dev gettext libgles2-mesa-dev libsdl2-dev libgles2-mesa-dev libsdl2-dev` | 成功安装     |
  | 4    | 配置GitHub加速 <br>`printf '140.82.121.3 github.com\n185.199.108.153 assets-cdn.github.com\n sudo tee -a /etc/hosts > /dev/null' `<br>`sudo /etc/init.d/networking restart` | 成功配置     |
  | 5    | 安装GL4ES并进入编译目录<br>`git clone https://github.com/ptitSeb/gl4es`<br>`cd gl4es` | 成功安装     |
  | 6    | 创建编译输出目录<br>`mkdir build`<br>`cd build`              | 成功建立     |
  | 7    | 运行CMake配置编译参数并进行多线程编译 <br>`cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo  -DCMAKE_C_COMPILER=riscv64-plctxthead-linux-gnu-gcc  -DNOX11=ON  -DFB=ON`<br>`make -j$(nproc)` | 成功运行     |
  | 8    | 获取Luanti项目源码  <br>`git clone --depth 1 https://github.com/luanti-org/luanti` | 成功获取     |
  | 9    | 进入git克隆的Luanti源码目录  <br>`cd luanti`                 | 成功进入     |
  | 10   | 编译Luanti项目 <br>`mkdir build`<br>`cd build`<br>`cmake ..  -DUSE_SDL2=ON  -DENABLE_OPENGL=OFF  -DENABLE_GLES2=ON  -DRUN_IN_PLACE=TRUE  -DENABLE_OPENGL3=OFF  -DCMAKE_C_COMPILER=/home/debian/venv-lpi4a-gcc/bin/riscv64-plctxthead-linux-gnu-gcc  -DCMAKE_CXX_COMPILER=/home/debian/venv-lpi4a-gcc/bin/riscv64-plctxthead-linux-gnu-g++  -DCMAKE_PREFIX_PATH=$(pwd)/../../gl4es/build` | 成功编译     |
  | 11   | 多线程编译Luanti项目 <br>`make -j$(nproc)`                   | 成功编译     |
  | 12   | 创建启动脚本run.sh <br>#!/bin/bash<br><br>`  export LIBGL_FB=1  `<br>`  export LIBGL_SHRINK=1`<br>`  export LIBGL_ES=2`<br>`  export LIBGL_GL=21`<br>`  export LIBGL_ALWAYS_SOFTWARE=1`<br>`  export LIBGL_EGL=1`<br>`  export LIBGL_NOVULKAN=1`<br>`  export LIBGL_NODRI=1`<br>`  export MESA_LOADER_DRIVER_OERRIDE=swrast `<br>`export GALLIUM_DRIVER=softpipe`<br>`export LD_LIBRARY_PATH="/home/debian/licheepi-new/gl4es/build/lib:$LD_LIBRARY_PATH"`<br>`/home/debian/licheepi-new/gl4es/build/luanti/bin/luanti` | 成功创建     |
  | 13   | 启动游戏 <br>`sudo chmod +x run.sh`<br>`./run.sh`            | 成功启动     |

  ---

  ## 关于虚拟环境中 Ruyi GCC 编译适配的调试
  配置 CMake（强制绑定 Ruyi 工具链 + 嵌入式适配）

  - gl4es中的关键调试：

  ```bash
  cmake .. \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DCMAKE_C_COMPILER=riscv64-plctxthead-linux-gnu-gcc \
    -DNOX11=ON  # 适配RevyOS无X11环境
    -DFB=ON      # 启用帧缓冲支持
  ```
  - Luanti中的关键调试：

  ```bash
  cmake .. \
    -DUSE_SDL2=ON \
    -DENABLE_OPENGL=OFF \
    -DENABLE_GLES2=ON  \
    -DRUN_IN_PLACE=TRUE \
    -DENABLE_OPENGL3=OFF  \
    # 替换为 Ruyi 工具链绝对路径
    -DCMAKE_C_COMPILER=/home/debian/venv-lpi4a-gcc/bin/riscv64-plctxthead-linux-gnu-gcc  \
    -DCMAKE_CXX_COMPILER=/home/debian/venv-lpi4a-gcc/bin/riscv64-plctxthead-linux-gnu-g++  \
    -DCMAKE_PREFIX_PATH=$(pwd)/../../gl4es/build
  ````

  # 附录 : 常见问题
  ## Ruyi update 拉取包缓存失败
  问题描述：执行 `ruyi update` 包索引拉取失败；

  解决方案：清理旧缓存，重新配置镜像源

  ```bash
  rm -rf ~/.cache/ruyi
  
  ruyi config set repo.remote https://mirror.iscas.ac.cn/git/ruyisdk/packages-index.git
  ```
  ## CMake 提示「Could NOT find ZLIB (missing: ZLIB_LIBRARY)」
  问题描述：编译 Luanti 时，CMake 无法识别系统 ZLIB 库，即使已安装 `zlib1g-dev`；

  解决方案：先确认系统 ZLIB 实际路径，再修改 CMake 命令，显式指定 ZLIB 路径

  ```bash
  find /usr/lib -name "libz.so"
  find /usr/include -name "zlib.h"
  
  cmake .. \
    -DUSE_SDL2=ON \
    -DENABLE_OPENGL=OFF \
    -DENABLE_GLES2=ON  \
    -DRUN_IN_PLACE=TRUE \
    -DENABLE_OPENGL3=OFF  \
    -DCMAKE_C_COMPILER=/home/debian/venv-lpi4a-gcc/bin/riscv64-plctxthead-linux-gnu-gcc  \
    -DCMAKE_CXX_COMPILER=/home/debian/venv-lpi4a-gcc/bin/riscv64-plctxthead-linux-gnu-g++  \
    -DCMAKE_PREFIX_PATH=$(pwd)/../../gl4es/build \
    # 新增：指定 ZLIB 头文件和库文件路径
    -DZLIB_INCLUDE_DIR=/usr/include \
    -DZLIB_LIBRARY=/usr/lib/riscv64-linux-gnu/libz.so
  ```
  ## 使用./run.sh时无法启动
  原因：未真正创建启动脚本，导致权限无法生效。
  解决方案：执行编辑命令真正创建脚本执行路径

  ```bash
  nano run.sh# 打开脚本进行以下编辑后直接按Ctrl+O保存、Ctrl+X退出
  #!/bin/bash
  
  export LIBGL_FB=1
  export LIBGL_SHRINK=1
  export LIBGL_ES=2
  export LIBGL_GL=21
  export LIBGL_ALWAYS_SOFTWARE=1
  export LIBGL_EGL=1
  export LIBGL_NOVULKAN=1
  export LIBGL_NODRI=1
  
  export MESA_LOADER_DRIVER_OVERRIDE=swrast
  export GALLIUM_DRIVER=softpipe
  
  export LD_LIBRARY_PATH="path/to/gl4es/lib/:$LD_LIBRARY_PATH"
  path/to/luanti/bin/luanti
  ```
